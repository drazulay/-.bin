#! /usr/bin/env bash

PATH="/bin:/usr/bin:/sbin:/usr/sbin:/usr/local/bin:/usr/local/sbin"
export PATH

[ -z $1 ] && VOLUME="CONFIG" || VOLUME="$1"
shift 1
[ -z $1 ] && VOLUMES_DIR="/Volumes" || VOLUMES_DIR="$1"

set -eo pipefail

CONFIG_FILE="$HOME/.bin/backup-config.conf"

if [ ! -d ${VOLUMES_DIR}/${VOLUME} ]; then
    echo "Volume ${VOLUME} is not mounted. Please mount a volume named ${VOLUME} and try again."
    exit 1
fi

SUDO=$(which sudo)
RSYNC=$(which rsync)
AWK=$(which awk)

[ -z "${SUDO}" ] && echo "The command sudo is required to be installed to run backup-config."
[ -z "${RSYNC}" ] && echo "The command rsync is required to be installed to run backup-config."
[ -z "${AWK}" ] && echo "The command awk is required to be installed to run backup-config."

DATE="$(date +%d-%m-%Y)"
VOLUME_PATH="${VOLUMES_DIR}/${VOLUME}/${DATE}${HOME}/"

echo "Sudo privileges are required to run this command."

sudo --validate

if [ $? -ne 0 ]; then
    EXIT=$?
    echo "Authentication failure, exiting.."
    exit ${EXIT}
fi

echo -e "\nStarting backup..\n"

sudo mkdir -pv ${VOLUME_PATH}

while read -r PATH; do
    BACKUP_PATH="${PATH/~\//${VOLUME_PATH}}"
    PATH="${PATH/~\//${HOME}/}"

    if ([ ! -e ${PATH} ] || [ -L ${PATH} ] || [ -h ${PATH} ] || [ -S ${PATH} ]); then
		continue
	fi

	if [ -d ${PATH} ]; then
		PRE_DIR=$(echo "${BACKUP_PATH}" | ${AWK} 'BEGIN{FS=OFS="/"} {NF--} 1')
		#[ ! -d ${BACKUP_PATH} ] && ${SUDO} /bin/mkdir -pv ${BACKUP_PATH}
		${SUDO} ${RSYNC} -riam --sparse --update --perms --out-format="%o (%l bytes) | %f --> ${PRE_DIR}/%n" --prune-empty-dirs ${PATH} ${PRE_DIR/}
	fi

	if [ -f ${PATH} ]; then
		PATH_DIR=$(echo "${BACKUP_PATH}" | ${AWK} 'BEGIN{FS=OFS="/"} {NF--} 1')
		#[ ! -d ${PATH_DIR} ] && ${SUDO} /bin/mkdir -pv ${PATH_DIR}
		${SUDO} ${RSYNC} -ria --sparse --update --perms --out-format="%o (%l bytes) | %f --> ${PATH_DIR}/%n/" ${PATH} ${PATH_DIR}/
	fi

done <$CONFIG_FILE

echo -e "\nDone.\nEject volume ${VOLUME} if it is an external storage device and keep it safely stored."
